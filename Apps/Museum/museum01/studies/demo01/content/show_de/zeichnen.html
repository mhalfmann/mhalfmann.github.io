<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></head>
<body onload="checkready();">
	<script src="../../../app/iwm_studyaddon.js"></script>
	<div id="iwmstudy_masterbox"><div id="iwmstudy_centerbox">	
	
		<!-- Überschrift -->
		<div id="iwmstudy_headlinebox">Interaktiv: Zeichnen (Touch)</div>
				
		<!-- Inhalt -->
		<div id="iwmstudy_contentbox">
			<div class="iwmstudy_text">
				Interaktive Aufgaben werden durch JavaScript unterstützt.<br/>
				<br/>
                Zeichenfläche (Touch):                
            </div>			
            <br/>
			<canvas id="canvas" width="800" height="600" style="border:1px solid grey;" ontouchstart="tstart(event)" ontouchmove="tmove(event)" ontouchend="tend(event)"></canvas>
			</br>
			<button type="button" onclick="initStoreImage(event)" style="height: 40px; width: 120px;">Bild speichern</button>
		</div>		
		
	</div></div>
	<script>		
		var context = document.getElementById('canvas').getContext("2d");		
		var touchesX = new Array();
		var touchesY = new Array();
		var touchDrag = new Array();
		var paint;
		var strokes = new Array();
		var starttime;
		
		function initStoreImage(event){
			event.currentTarget.disabled = true;			
			canvas.toBlob(storeImage, "image/png");
			
		}

		function storeImage(blob){
			let filename = "image_" + Date.now() + ".png";			
			iwmstudy_access.storeFile(filename,blob)
		}

		function checkready(){
			if(window.iwmstudy_access.isPageReady()){
				init();
			}
			else{				
				setTimeout(checkready, 100);
			}
		}
		
		function init(){			
			starttime = Date.now();	
		}

		class Stroke{
			constructor(x,y){		
				this.tstart = Date.now() - starttime;
				this.tend;
				this.xvalues = [x];
				this.yvalues = [y];				
			}
			
			addPoint(x,y){
				this.xvalues.push(x);
				this.yvalues.push(y);
			}
			
			finish(){
				this.tend = Date.now() - starttime;				
			}
			
			getInkComponent(){
				return new InkComponent(this.xvalues, this.yvalues);
			}
			
			getLogData(){
				let d = this.tstart + "|" + this.tend + "|" + this.xvalues.join("-")  + "|" + this.yvalues.join("-");
				return d;
			}
		}	

		class InkComponent{
			constructor(x,y){
				this.type = "stroke";
				this.x = x;
				this.y = y;
			}		
		}
		
		function getInkComponents(){
			let inkcomps = new Array();
			for(let i=0; i<strokes.length; i++){
				inkcomps.push(strokes[i].getInkComponent());
			}
			return inkcomps;
		}		
		
		function addTouch(x, y, dragging)
		{
			touchesX.push(x);
			touchesY.push(y);
			touchDrag.push(dragging);
		}
		
		function redraw(){
			context.clearRect(0, 0, context.canvas.width, context.canvas.height); // Clears the canvas  
			context.strokeStyle = "#000000";
			context.lineJoin = "round";
			context.lineWidth = 5;			
			for(var i=0; i < touchesX.length; i++) {		
				context.beginPath();
				if(touchDrag[i] && i){
					context.moveTo(touchesX[i-1], touchesY[i-1]);
				}
				else{
					context.moveTo(touchesX[i]-1, touchesY[i]);
				}
				context.lineTo(touchesX[i], touchesY[i]);
				context.closePath();
				context.stroke();
			}
		}

		function clearCanvas(e){			
			touchesX = new Array();
			touchesY = new Array();
			touchDrag = new Array();
			context.clearRect(0, 0, context.canvas.width, context.canvas.height); // Clears the canvas  
		}
				
		function tstart(e){	
			e.preventDefault();
			paint = true;
			let x = e.touches[0].clientX - canvas.offsetLeft - document.getElementById("iwmstudy_centerbox").offsetLeft;
			let y = e.touches[0].clientY - canvas.offsetTop - document.getElementById("iwmstudy_centerbox").offsetTop;
			addTouch(x, y);
			strokes.push(new Stroke(x, y));
			redraw();
			window.iwmstudy_access.logAction("startstroke",{x:x,y:y})
		}
		
		function tmove(e){
			e.preventDefault();
			if(paint){
				let x = e.touches[e.touches.length-1].clientX - canvas.offsetLeft - document.getElementById("iwmstudy_centerbox").offsetLeft;
				let y = e.touches[e.touches.length-1].clientY - canvas.offsetTop - document.getElementById("iwmstudy_centerbox").offsetTop;
				addTouch(x, y, true);
				strokes[strokes.length-1].addPoint(x,y);
				redraw();
			}
		}
		
		function tend(e){
			e.preventDefault();
			paint = false;
			strokes[strokes.length-1].finish();	
			window.iwmstudy_access.logAction("endstroke",{strokenumber:strokes.length})		
		}			
	</script>
</body>