<!doctype HTML>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" charset="utf-8">
</head>
<body onselectstart = 'return false' onwheel="preventScroll(event)" style='margin : 0px; overflow: hidden; background:  rgb(82, 82, 82); font-family: "Open Sans";'>    

<script src="./assets/text.js"></script>
<script src="./assets/images.js"></script>
<script src="./javascript/utility.js"></script>
<script src="./javascript/variables.js"></script>
<script src="../../../../app/iwm_studyaddon.js"></script>
<!-- <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1"> -->
<!-- <script src="./Javascript/aframe.min.js"></script> -->
<!-- <script src="./Javascript/aframe-ar.js"></script> -->
<!-- <script src="../../../Javascript/hammer.js"></script> -->
<script src="../../Javascript/TweenMax.min.js"></script>
<script src="../../Javascript/jquery-3.6.0.min.js"></script>
<!-- <script src="../../../Javascript/jquery.csv.js"></script> -->
<!-- <script src="../../../Javascript/papaparse.min.js"></script> -->
<link rel="stylesheet" type="text/css" href="./css/style.css">
<link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Open+Sans" />
<style>

</style>
  <div id="main">

    <div id="goLeft" class="button" style ="left: 5px; top: 47vh; height: 6vh; width:6vh; opacity: 0.1;">
      <img id="leftArrow" src="../../Assets/Icons/arrow-back.png" width="100%">
    </div>
    <div id="goRight" class="button" style ="right: 5px; top: 47vh; height: 6vh; width:6vh;">
      <img id="rightArrow" src="../../Assets/Icons/arrow-forward.png" width="100%">
    </div>
    
    <!-- <ul id = "imageBar" style ="list-style: none; position: absolute; right: 10%; top: 10%; height: 80%; width:80%; display: flex; overflow-y: hidden; overflow-x: auto;"> -->
    <ul id = "imageBar" tabindex="0" style="outline:none;">
    </ul>

    <div id="infoCard">
      <div id="infoImage" style="position: absolute; height: 100%; width: 70%;"> 
        <img id="infoImageIMG" onload="loaded(this)">
      </div>
      <div id="infoText">
        <div id="infoTextTXT"></div>
      </div>
      <div id = "closeInfoCard" onclick="closeInfoCard()">
        <img src="../../Assets/Icons/close.png" height="100%">
      </div>
    </div>
   <!--  <div class="button" onclick="changeLang(this)" lang="DE" style="right: 5%; bottom: 5%;">
      DE
    </div> -->
    <div class="button" onclick="exit(this)" lang="DE" style="right: 5%; bottom: 5%;">
      Beenden
    </div>
    <div id="output" style="opacity: 0; position: absolute; left: 55%; bottom: 5%; background: rgb(63, 63, 63); padding: 10px; color:white; border-radius: 5px;">
      Output
    </div>
    <div id="timeText">
      10:00
    </div>
    <!-- <div class="button" onclick="clickMe()" id="clickMe">
      clickMe
    </div> -->
    
  </div>
  <div id="overlay">
    <div id="overlayText">      
      Bitte Leertaste dr√ºcken
    </div>
  </div>
  <div id="leftBar" class = "fovBar" style = "left: 30%; top: 0%;">
  </div>
  <div id="rightBar" class = "fovBar" style = "right: 30%; top: 0%;">
  </div>
  <script>
    console.log("Version: "+version)
    // console.log("URL: "+location)
    if(location.toString().indexOf("github.io")>-1)timer = 1000

    let siteTitle = ''
    window.addEventListener('blur', () => {
      siteTitle = document.title
      document.title = 'Come back!'
      console.log("page left")
    })
    window.addEventListener('focus', () => {
      document.title = siteTitle
      console.log("page entered")
    })

    let condition = "2D_Multi"

    let iCard = document.getElementById("infoCard")
    let iImage = document.getElementById("infoImageIMG")
    let iText = document.getElementById("infoTextTXT")
    let imgBar = document.getElementById("imageBar")

    let right = false
    let left = false

    let infoTextString = ""

    let screenHeight = window.innerHeight
    let screenWidth = window.innerWidth
    let imgBarHeight = imgBar.getBoundingClientRect().height
    let imgBarWidth = imgBar.getBoundingClientRect().width

    let maxImgHeight = 0
    let maxImgWidth = 0
    
    let thumbnailArray = []

    let leftIMG = null
    let rightIMG = null

    // changeOrientation();

    // console.log(sessionStorage.getItem("start"))
    // sessionStorage.setItem("start", "true")

    iCard.style.visibility="hidden"

    overlayText.style.top = (screenHeight/2 - overlayText.getBoundingClientRect().height/2) +"px"

    function changeLang(target){
      switch(target.getAttribute('lang')){
        case "DE":
          target.innerHTML = "EN"
          target.setAttribute('lang','EN')
          language = "EN"
          if(iCard.style.visibility=="visible")document.getElementById("infoTextTXT").innerHTML = document.getElementById(iCard.getAttribute('imgID')).getAttribute('textEN')
          break;
        case "EN":
          target.innerHTML = "DE"
          target.setAttribute('lang','DE')
          language = "DE"
          if(iCard.style.visibility=="visible")document.getElementById("infoTextTXT").innerHTML = document.getElementById(iCard.getAttribute('imgID')).getAttribute('textDE')
          break;
      }
    }
    // document.getElementById("header").innerHTML = Gm338.text
    // console.log(screenWidth+" x "+screenHeight)

    for(var i=0; i<images.length; i++){
        if(images[i].height>maxImgHeight) maxImgHeight = images[i].height
        if(images[i].width>maxImgWidth) maxImgWidth = images[i].width
    }

    addImages()
    // console.log(viewingTimes)

    function clickMe(){

      // thumbnailArray[0].src = thumbnailArray[10].src

      // thumbnailArray[0].style.width = thumbnailArray[10].width+"px"
      // thumbnailArray[0].style.height = thumbnailArray[10].height+"px"
      console.log("------------------------------")
      console.log("offset left  " + getLeftImg())
      console.log("offset right  " + getRightImg())
    }
  
    function addImages(){
    
      for(var i=0; i<images.length; i++){
        // let img = imageArray[i]
        let img = images[i]
        infoTextString = ""

        // let thumbnailFrame = document.createElement('li')
        // thumbnailFrame.className ="thumbnailFrame"
        // document.getElementById("imageBar").appendChild(thumbnailFrame)

        let thumbnail = document.createElement('img')

        thumbnail.className ="thumbnail"
        thumbnail.src = img.file
        thumbnail.id = img.id
        thumbnail.setAttribute("objNumber",(i+1).toString())
        
        viewingTimes[img.id]=0

        thumbnail.style.marginRight = "10vw"
        // if(img.id.toString().indexOf("Gm1079")>-1){
        //   thumbnail.style.marginRight = "1vw"
        // }
        // if(img.id.toString().indexOf("Gm1079R")>-1){
        //   thumbnail.style.marginRight = "5vw"
        // }

        let f = imgBarHeight/maxImgHeight

        thumbnail.style.width = f*img.width+"px"
        thumbnail.style.height = f*img.height+"px"
        
        let top = (imgBarHeight - f*img.height)/2
        thumbnail.style.marginTop = top+"px"

        document.getElementById("imageBar").appendChild(thumbnail)        

        thumbnail.addEventListener('load',(e)=>{
          addText(e.target)
        })

        thumbnail.addEventListener('click',(e)=>{
          if(iCard.style.visibility=="hidden"){
            iImage.src = e.target.src
            iCard.setAttribute('imgID', e.target.id)
            iCard.setAttribute('objNumber', e.target.getAttribute("objNumber"))
            if(language == "DE")document.getElementById("infoTextTXT").innerHTML = e.target.getAttribute('textDE')
            if(language == "EN")document.getElementById("infoTextTXT").innerHTML = e.target.getAttribute('textEN')

            // console.log(e.target.id,currentTime)
            infoCardStartTime = getCurrentTime()
            let deltaT = infoCardStartTime - infoCardEndTime
            objectSequence+=" None_"+deltaT
            objectNumberSequence+=" None_"+deltaT
            logString("infoCardOpened","ObjectName#"+e.target.id+"*ObjectNumber#"+e.target.getAttribute("objNumber"))
            disableArrowButtons()
          }
        })
        thumbnailArray.push(thumbnail)
      }
    }
    let isKeyDown = false
    document.addEventListener('keydown', function(event) {

      if(!isKeyDown){
        isKeyDown = true
        console.log("key down "+event.keyCode)
        if(event.keyCode == 37) {
          /* console.log("left")
          imgBar.focus()
          goRight.style.opacity = 1 */
         /*  $('#imageBar').animate({
              scrollLeft: $('#imageBar').scrollLeft()-30
              // scrollLeft: $('#imageBar').scrollLeft()-(imgBarWidth*0.5)
          }, 0) */
        }
        if(event.keyCode == 39) {
          /* console.log("right")
          imgBar.focus()
          goLeft.style.opacity = 1 */
          /* $('#imageBar').animate({
              scrollLeft: $('#imageBar').scrollLeft()+30
              // scrollLeft: $('#imageBar').scrollLeft()+(imgBarWidth*0.5)
          }, 0) */
        }
        if(event.keyCode == 32) {
          if(!gameOver && !running){
            running = true
            overlay.style.visibility = "hidden"
            let data = ""
            
            let d = new Date() 
            startTime = d.getTime()
            infoCardEndTime = getCurrentTime()

            for(var i=0; i<thumbnailArray.length; i++){
              data+="Z"+thumbnailArray[i].id+"#"+isObjectVisible(thumbnailArray[i])+"*"
            }
            logString("ObjectsVisibleTotal",data)

            data = ""
            for(var i=0; i<thumbnailArray.length; i++){
              data+="Z"+thumbnailArray[i].id+"#"+isObjectVisibleCenter(thumbnailArray[i])+"*"
            }
            logString("ObjectsVisibleCenter",data)
            
            incrementCount(timer)
          }
        }
      }
    })

    document.addEventListener('keyup', function(event) {
      isKeyDown = false
      
      // let dL = thumbnailArray[0].getBoundingClientRect().left-imgBar.getBoundingClientRect().left
      // let dR = thumbnailArray[thumbnailArray.length-1].getBoundingClientRect().right-imgBar.getBoundingClientRect().right
      // console.log(dL + " "+ dR)
      // if(dL>1)goLeft.style.opacity = 0.1
      // if(dR<1)goRight.style.opacity = 0.1
    })

    function getLeftImg(){
      let leftPos = 0
      let l = 0
      for (var i=0; i<thumbnailArray.length; i++){
        let thumb = thumbnailArray[i]
        if(thumb.getBoundingClientRect().right>imgBar.getBoundingClientRect().left){
          leftIMG = thumb
          leftPos = i-1
          break
        }
      }
      
      if(leftPos>-1)l = Math.abs(thumbnailArray[leftPos].getBoundingClientRect().left-imgBar.getBoundingClientRect().left)
      console.log("leftIMG = " + leftIMG.id)
      return l
    }

    function getRightImg(){
      let rightPos = 0
      let l = 0
      for (var i=thumbnailArray.length-1; i>0; i--){
        let thumb = thumbnailArray[i]
        if(thumb.getBoundingClientRect().left<imgBar.getBoundingClientRect().right){
          rightIMG = thumb
          rightPos = i+1
          break
        }
      }
      
      // l = Math.abs(thumbnailArray[rightPos].getBoundingClientRect().right-rightIMG.getBoundingClientRect().right)
      if(rightPos<thumbnailArray.length)l = Math.abs(thumbnailArray[rightPos].getBoundingClientRect().right-imgBar.getBoundingClientRect().right)

      /*for (var i=rightPos; i<thumbnailArray.length-1; i++){
        let diff = thumbnailArray[i+1].getBoundingClientRect().left-thumbnailArray[i].getBoundingClientRect().left
        l+=diff
        if(l>imgBar.getBoundingClientRect().width){
          l-=diff
          break
        }
      }*/
      console.log("rightIMG = " + rightIMG.id)
      // console.log(imgBar.getBoundingClientRect().width+"  "+l)
      return l
    }
/*let mousedownID = -1;  //Global ID of mouse down interval
  function mousedown(event) {
    if(mousedownID==-1)  //Prevent multimple loops!
      mousedownID = setInterval(whilemousedown, 100 );
  }
  function mouseup(event) {
    if(mousedownID!=-1) {  //Only stop if exists
      clearInterval(mousedownID);
      mousedownID=-1;
    }
  }
  function whilemousedown(e) {
    console.log("mouse down")
    if(right){
      $('#imageBar').animate({
            scrollLeft: $('#imageBar').scrollLeft()+50
        }, 10)
    }
    if(left){
      $('#imageBar').animate({
            scrollLeft: $('#imageBar').scrollLeft()-50
        }, 10)
    }
  }
//Assign events
document.addEventListener("mousedown", mousedown);
document.addEventListener("mouseup", mouseup);
//Also clear the interval when user leaves the window with mouse
document.addEventListener("mouseout", mouseup);

    document.getElementById("goRight").addEventListener('pointerover',(e)=>{
      right = true
    })
    document.getElementById("goRight").addEventListener('pointerleave',(e)=>{
      right = false
    })
    document.getElementById("goLeft").addEventListener('pointerover',(e)=>{
      left = true
    })
    document.getElementById("goLeft").addEventListener('pointerleave',(e)=>{
      left = false
    })*/

    document.getElementById("goRight").addEventListener('click',(e)=>{
      goLeft.style.opacity = 1
      disableThumbnails()
      let offset = getRightImg()
      logString("ArrowClick","ChangeDirection#Right")
      $('#imageBar').animate({
          // scrollLeft: $('#imageBar').scrollLeft()+(imgBarWidth*0.5)
          scrollLeft: $('#imageBar').scrollLeft()+(offset)
      }, 1.5*offset,animateComplete)
    })

    document.getElementById("goLeft").addEventListener('click',(e)=>{
      goRight.style.opacity = 1
      disableThumbnails()
      let offset = getLeftImg()
      logString("ArrowClick","ChangeDirection#Left")
      $('#imageBar').animate({
          // scrollLeft: $('#imageBar').scrollLeft()-(imgBarWidth*0.5)
          scrollLeft: $('#imageBar').scrollLeft()-(offset)
      }, 1.5*offset,animateComplete)
    })

    function animateComplete(){
      console.log("animate completed")
      let dL = thumbnailArray[0].getBoundingClientRect().left-imgBar.getBoundingClientRect().left
      let dR = thumbnailArray[thumbnailArray.length-1].getBoundingClientRect().right-imgBar.getBoundingClientRect().right
      // console.log(dL + " "+ dR)
      if(dL>-1)goLeft.style.opacity = 0.1
      if(dR<1)goRight.style.opacity = 0.1
      enableThumbnails()
      let data = ""
      for(var i=0; i<thumbnailArray.length; i++){
        data+="Z"+thumbnailArray[i].id+"#"+isObjectVisible(thumbnailArray[i])+"*"
      }
      logString("ObjectsVisibleTotal",data)
            
      data = ""
      for(var i=0; i<thumbnailArray.length; i++){
        data+="Z"+thumbnailArray[i].id+"#"+isObjectVisibleCenter(thumbnailArray[i])+"*"
      }
      logString("ObjectsVisibleCenter",data)
    }
    
    window.addEventListener("orientationchange", function() {
      // changeOrientation()
    }, false)

  </script>
  </body>
</html>