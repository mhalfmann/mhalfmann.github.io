<!doctype HTML>
<html>
<meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
<script src="./Javascript/aframe.min.js"></script>
<script src="./Javascript/aframe-ar.js"></script>
<script src="./Javascript/hammer.js"></script>
<link rel="stylesheet" type="text/css" href="./css/ui.css">
<!-- <script src="./Javascript/jquery-3.4.0.min.js"></script> -->
<!-- <script src="./Javascript/TweenMax.min.js"></script> -->
  <body style='margin : 0px; overflow: hidden;'>
      <script>
          AFRAME.registerComponent('set-marker', {
            init: function () {
              
              window.markers = document.querySelectorAll('a-marker')

                let marker = document.getElementById('Elastomer')
                let legend = document.getElementById('legendeElastomer')

                let objects = []

                window.objectsLoaded = 0
                window.pointerCount = 0

                objects[0] = document.getElementById('model1')
                objects[1] = document.getElementById('model2')
                objects[2] = document.getElementById('model3')
                objects[3] = document.getElementById('model4')

                for(var i = 0; i<objects.length; i++){
                  objects[i].addEventListener('model-loaded',()=>{
                    window.objectsLoaded++
                    // document.getElementById('version').innerHTML = window.objectsLoaded
                  })

                  if(i!=0) objects[i].object3D.visible = false
                  if(i!=0) objects[i].object3D.scale.set(5,5,5)
                }

                let currentObject = objects[0]

                marker.setAttribute('found','false')

                marker.setAttribute('state','0')
                      
                let rotX = 0.0
                let rotY = 0.0
                let oldX = 0.0
                let oldY = 0.0
                let diffX = 0.0
                let diffY = 0.0
                let rotate = false
                let allowZoom = false
                let pinch = true

                let cam = document.getElementById('cam')

                let button = document.getElementById('button')
                let name = document.getElementById('name')
                let legendButton = document.getElementById('legendButton')
                let zoomInButton = document.getElementById('zoomInButton')
                let zoomOutButton = document.getElementById('zoomOutButton')
                let layersButton = document.getElementById('layersButton')
                let layers = document.getElementById('layers')
                layers.style.visibility = "hidden"

                // let objectButton = document.getElementById('objectButton')
                let spaghettiButton = document.getElementById('spaghettiButton')
                let spacefillButton = document.getElementById('spacefillButton')
                let ballstickButton = document.getElementById('ballstickButton')

                let foundMarkers = new Map()

                // document.getElementById('legende').style.visibility = 'hidden'

                let test = false
                let deltaS = 0.0
                let oldScale = 0.0
                let latestLayerState = 1

                let blendInThreshold = 3.0
                let blendOutThreshold = 0.8
                let zoomInThreshold = 5.5
                let zoomOutThreshold = 0.5

                var hammertime = new Hammer(document.body)

                hammertime.get('pan').set({ threshold: 0 })
                hammertime.get('pinch').set({ enable: true })

                marker.addEventListener('markerFound', (e)=>{
                    // console.log('marker found',e.target.id)
                    name.innerHTML=e.target.id
                    name.style.opacity = 1.0
                    button.style.visibility ="hidden"
                    if(!foundMarkers.has(e.target.id))foundMarkers.set(e.target.id, document.getElementById(e.target.id))

                    marker.setAttribute('found','true')
                    allowZoom = true

                  })
                  marker.addEventListener('markerLost', (e)=>{
                    // console.log('marker lost',e.target.id)
                    if(foundMarkers.has(e.target.id))foundMarkers.delete(e.target.id)
                    if(foundMarkers.size<1){
                      button.style.visibility = "visible"
                      name.style.opacity = 0.0
                      allowZoom = false
                      // legendeNudel.style.visibility = 'hidden'
                    }
                    marker.setAttribute('found','false')
                  })                  

                layersButton.addEventListener('click',()=>{
                  switch(document.getElementById('layers').style.visibility){
                    case 'hidden':
                          document.getElementById('layers').style.visibility="visible"
                          break;
                    case 'visible':
                          document.getElementById('layers').style.visibility="hidden"
                          break;
                  }
                })

                /* objectButton.addEventListener('click',()=>{
                  if(marker!=null && marker.getAttribute('found')=='true'){
                        let cState = 0
                        marker.setAttribute('state',cState.toString())
                        // document.getElementById('layers').style.visibility="hidden"
                        switchObjectsState()
                    }
                }) */
                spaghettiButton.addEventListener('click',()=>{
                  if(marker!=null && marker.getAttribute('found')=='true' && cState!=0){
                        let cState = 1
                        latestLayerState = 1
                        marker.setAttribute('state',cState.toString())
                        // document.getElementById('layers').style.visibility="hidden"
                        switchObjectsState()
                    }
                })
                spacefillButton.addEventListener('click',()=>{
                  if(marker!=null && marker.getAttribute('found')=='true' && cState!=0){
                        let cState = 2
                        latestLayerState = 1
                        marker.setAttribute('state',cState.toString())
                        // document.getElementById('layers').style.visibility="hidden"
                        switchObjectsState()
                    }
                })
                ballstickButton.addEventListener('click',()=>{
                  if(marker!=null && marker.getAttribute('found')=='true' && cState!=0){
                        let cState = 3
                        latestLayerState = 1
                        marker.setAttribute('state',cState.toString())
                        // document.getElementById('layers').style.visibility="hidden"
                        switchObjectsState()
                    }
                })

                  zoomInButton.addEventListener('click',(e)=>{
                    if(marker!=null){
                          let cState = parseInt(marker.getAttribute('state'))
                          cState++
                          if(cState>3)cState=3
                          marker.setAttribute('state',cState.toString())
                          switchObjectsState()
                      }

                  })
                  zoomOutButton.addEventListener('click',(e)=>{
                    if(marker!=null){
                          let cState = parseInt(marker.getAttribute('state'))
                          cState--
                          if(cState<0)cState=0
                          marker.setAttribute('state',cState.toString())
                          switchObjectsState()
                      }

                  })

                hammertime.on('pinch', function(ev) {
                  if(allowZoom){
                    // rotate = false
                    let cScale = currentObject.object3D.scale
                    // document.getElementById('version').innerHTML = cScale.x
                    let deltaS = ev.scale-oldScale
                    if(oldScale !=0.0){
                      if(currentObject==objects[0]){
                        if(currentObject!=null && pinch == true && cScale.x+deltaS>1 && cScale.x+deltaS < 5){
                            objects[0].object3D.scale.set(cScale.x+deltaS, cScale.y+deltaS, cScale.z+deltaS)
                            if(cScale.x+deltaS>5){
                              cState=latestLayerState
                              layers.style.visibility = "visible"
                              marker.setAttribute('state',cState.toString())
                              // if(currentObject!=null)currentObject.object3D.scale.set(5,5,5)
                              switchObjectsState()
                            }
                        }                        
                      }
                      if(currentObject!=objects[0]){
                        if(currentObject!=null && pinch == true && cScale.x+deltaS>4 && cScale.x+deltaS < 20){
                            objects[1].object3D.scale.set(cScale.x+deltaS, cScale.y+deltaS, cScale.z+deltaS)
                            objects[2].object3D.scale.set(cScale.x+deltaS, cScale.y+deltaS, cScale.z+deltaS)
                            objects[3].object3D.scale.set(cScale.x+deltaS, cScale.y+deltaS, cScale.z+deltaS)
                            if(cScale.x+deltaS<4){
                              cState=0
                              layers.style.visibility = "hidden"
                              marker.setAttribute('state',cState.toString())
                              // if(currentObject!=null)currentObject.object3D.scale.set(5,5,5)
                              switchObjectsState()
                            }
                        }
                      }
                    }
                    oldScale = ev.scale
                  }
                })

                hammertime.on('pinchstart', function(ev) {
                  console.log('PINCH START')
                //   if(window.currentObject!=null)window.currentObject.object3D.scale.set(1,1,1)
                  // rotate = false
                })

                hammertime.on('pinchend', function(ev) {
                    oldScale = 0.0
                    pinch = true
          /*         if(window.currentObject!=null)window.currentObject.object3D.scale.set(1,1,1)
                  
                    // console.log('pinch END detected',ev.additionalEvent)
                  if(ev.additionalEvent=='pinchout'){
                    // console.log('pinch OUT detected')
                    if(window.currentMarker!=null){
                      let cState = parseInt(window.currentMarker.getAttribute('state'))
                      cState++
                      if(cState>4)cState=4
                      window.currentMarker.setAttribute('state',cState.toString())
                    }
                  }

                  if(ev.additionalEvent=='pinchin'){
                    if(window.currentMarker!=null){
                      let cState = parseInt(window.currentMarker.getAttribute('state'))
                      cState--
                      if(cState<0)cState=0
                      window.currentMarker.setAttribute('state',cState.toString())
                    }
                  }
                  switchObjectsState() */

                //   switchObjectsState()
                })

                function switchObjectsState(){
                  if(marker.getAttribute('found')=='true'){
                    let cState = parseInt(marker.getAttribute('state'))
                    // if(cState!=1)legendeNudel.style.visibility='hidden'
                    if(cState<2)legendeElastomer.style.visibility='hidden'
                    for(var i=0; i<objects.length; i++){
                      if(i!=cState)objects[i].object3D.visible =false
                      if(i==cState){
                        objects[i].object3D.visible =true
                        currentObject = objects[i]
                      }
                    }
                  } 
                }
                document.body.addEventListener('pointerdown',()=>{
                    oldX = 0.0
                    oldY = 0.0
                    // rotate = true
                    window.pointerCount++
                    // cube.object3D.rotation.y += 1.0
                  })
                  document.body.addEventListener('pointerup',()=>{
                    oldX = 0.0
                    oldY = 0.0
                    // rotate = false
                    window.pointerCount--
                  })

                  
                document.body.addEventListener('pointermove',(e)=>{
                                    
                
                })
                  hammertime.on('pan', (e) => {
                      if(oldX!=0)diffX = (oldX-e.center.x)*0.5
                      if(oldY!=0)diffY = (oldY-e.center.y)*0.5
                    var vector = new THREE.Vector3()
                    vector.setFromMatrixPosition(currentObject.object3D.matrixWorld)
                    vector.project(AFRAME.scenes[0].camera)

                    var width = window.innerWidth, height = window.innerHeight
                    var widthHalf = width / 2, heightHalf = height / 2

                    vector.x = ( vector.x * widthHalf ) + widthHalf
                    vector.y = -( vector.y * heightHalf ) + heightHalf
                    if(currentObject !=null){
                        var xAxis = new THREE.Vector3(1, 0, 0)
                        var yAxis = new THREE.Vector3(0, 1, 0)
                        var zAxis = new THREE.Vector3(0, 0, 1)
                        let rotation = currentObject.getAttribute("rotation")
                        
                        if(vector.y>e.center.y){
                          if(currentObject==objects[0])objects[0].object3D.rotateOnWorldAxis ( yAxis, THREE.Math.degToRad(diffX) )
                          if(currentObject!=objects[0]){
                            objects[1].object3D.rotateOnWorldAxis ( yAxis, THREE.Math.degToRad(diffX) )
                            objects[2].object3D.rotateOnWorldAxis ( yAxis, THREE.Math.degToRad(diffX) )
                            objects[3].object3D.rotateOnWorldAxis ( yAxis, THREE.Math.degToRad(diffX) )
                          }
                        }
                        if(vector.y<=e.center.y){
                          if(currentObject==objects[0])objects[0].object3D.rotateOnWorldAxis ( yAxis, THREE.Math.degToRad(-diffX) )
                          if(currentObject!=objects[0]){
                            objects[1].object3D.rotateOnWorldAxis ( yAxis, THREE.Math.degToRad(-diffX) )
                            objects[2].object3D.rotateOnWorldAxis ( yAxis, THREE.Math.degToRad(-diffX) )
                            objects[3].object3D.rotateOnWorldAxis ( yAxis, THREE.Math.degToRad(-diffX) )
                          }
                        }                      
                      }
                      
                      oldX = e.center.x
                      oldY = e.center.y
                  })

                  legendButton.addEventListener('click',(e)=>{
                    var legends = document.querySelectorAll(".uiElement")
                  // console.log(legends[0].getAttribute('marker'), currentMarker.id)
                    if(marker!=null){
                     /*  if(parseInt(marker.getAttribute('state'))==1){
                      switch(legendeNudel.style.visibility){
                          case 'visible':
                              // if(parseInt(window.currentMarker.getAttribute('state'))==1)legendeNudel.style.visibility = 'visible'
                              // if(parseInt(window.currentMarker.getAttribute('state'))!=1)legendeNudel.style.visibility = 'hidden'
                              legendeNudel.style.visibility = 'hidden'
                            break
                          case 'hidden':
                              // if(parseInt(window.currentMarker.getAttribute('state'))==1)legendeNudel.style.visibility = 'visible'
                              // if(parseInt(window.currentMarker.getAttribute('state'))!=1)legendeNudel.style.visibility = 'hidden'
                              legendeNudel.style.visibility = 'visible'
                            break
                      }
                      } */
                      
                      if(parseInt(marker.getAttribute('state'))>1){
                          switch(legend.style.visibility){
                          case 'visible':
                            legend.style.visibility = 'hidden'
                            break
                          case 'hidden':
                            legend.style.visibility = 'visible'
                            break
                        }
                        }
                    }
                  })
                  
                  document.getElementById('homeButton').addEventListener('click',(e)=>{
                    // window.history.back();
                    location = "./indexStart.html"
                  })
            },
            tick: function () {

              document.getElementById('loading').innerHTML = "Lade Modelle " + window.objectsLoaded + " / 4"
              if(window.objectsLoaded == 4){                
                document.getElementById('overlay').style.visibility = "hidden"
              }
            },
          })
        </script>
      
      <a-scene renderer="logarithmicDepthBuffer: true; precision: low; antialias: false;" embedded arjs='debugUIEnabled: false; patternRatio: 0.5' vr-mode-ui='enabled: false' set-marker >
        <a-marker id = "Elastomer" cursor-listener type="pattern" url="./assets/marker/pattern-rubber.patt">
         <a-gltf-model id="model1" src="assets/models/rubber.gltf"></a-gltf-model>
         <a-gltf-model id="model2" src="assets/models/Elastomer_Nudel_neu.gltf"></a-gltf-model>
         <a-gltf-model id="model3" src="assets/models/Elastomer_Sphere_black.gltf"></a-gltf-model>
         <a-gltf-model id="model4" src="assets/models/Elastomer_Ball_black.gltf"></a-gltf-model>
       </a-marker>
 
       <a-entity id="cam" camera >
       </a-entity>
     </a-scene>
    <div id = "header" style="position: absolute; top: 0px; left: 0px; display: flex; flex-direction: row;">
      <div id="name" class="uiElement" style="margin: 5px; padding: 5px; opacity: 0;"></div>
    </div>

    <div id = "toolbar" style="position: absolute; bottom: 0px; left: 0px; display: flex;flex-direction: row;">
      <div id="legendButton" class="uiButton" style="margin: 5px; padding: 5px;">Legende</div>
      <!-- <div id="homeButton" class="uiButton" style="margin: 5px; padding: 5px;">Startseite</div> -->
      <img id="homeButton" src="./assets/icons/home.png" class="uiButton" style="width: 7vw; height: 7vw; margin: 5px; padding: 5px;">
      <div id="layers" class="uiElement" style="visibility: visible; display: flex;flex-direction: row;">
        <!-- <img id="objectButton" src="./assets/images/img_rubber.png" style="width: 7vw; height: 7vw; margin: 5px; padding: 5px;"> -->
        <img id="spaghettiButton" src="./assets/images/img_spaghetti.png" style="width: 7vw; height: 7vw; margin: 5px; padding: 5px;">
        <img id="spacefillButton" src="./assets/images/img_sphere.png" style="width: 7vw; height: 7vw; margin: 5px; padding: 5px;">
        <img id="ballstickButton" src="./assets/images/img_ball_stick.png" style="width: 7vw; height: 7vw; margin: 5px; padding: 5px;">
      </div>
      <img id="zoomInButton" src="./assets/icons/zoom_in.png" class="uiButton" style="margin: 5px; padding: 5px; display:none;">
      <img id="zoomOutButton" src="./assets/icons/zoom_out.png"class="uiButton" style="margin: 5px; padding: 5px; display:none;">
      <img id="layersButton" src="./assets/icons/layers.png"class="uiButton" style="margin: 5px; padding: 5px; display:none;">
    </div>  

    <div id="button" class="uiElement" style="position: absolute; top: 15%; left: 20%; visibility: visible;">
      <div id="buttonInfo" style="margin: 10px; color: white">Bitte Marker Scannen</div>
      <div id="buttonClickable" class= "innerButton" style="margin: 10px; width: 90%; height: 0vh; visibility: hidden; border-radius: 5px; ">      
        <div id="buttonAction" style="margin: 10px; padding: 5px; text-align: center; color:white"></div>
      </div>

    </div>

    <div id="legendeNudel" class="uiElement" style="position: absolute; top: 10%; left: 5%; display: flex; flex-direction: column; opacity: 0.8; visibility: hidden;">
      <div id="Verknuepfung" style="display: flex; flex-direction: row; margin: 1vh;">
        <div style="width: 2vh; height: 2vh; background: grey; border-radius: 50%; margin: 5px;" ></div>
        <div id="VerknuepfungInfo"> = Verknuepfung</div>
      </div>
    </div>
    
    <div id="legendeElastomer" class="uiElement" marker="Elastomer" style="position: absolute; top: 10%; left: 5%; display: flex; flex-direction: column; opacity: 0.8; visibility: hidden;">
      <div id="kohlenstoff" style="display: flex; flex-direction: row; margin: 1vh;">
        <div style="width: 2vh; height: 2vh; background: darkgray; border-radius: 50%; margin: 5px;" ></div>
        <div id="kohlenstoffInfo"> = Kohlenstoff</div>
      </div>
      <div id="schwefel" style="display: flex; flex-direction: row; margin: 1vh;">
          <div style="width: 2vh; height: 2vh; background: yellow; border-radius: 50%; margin: 5px;" ></div>
          <div id="schwefelInfo"> = Schwefel</div>
      </div>
      <div id="wasserstoff" style="display: flex; flex-direction: row; margin: 1vh;">
          <div style="width: 2vh; height: 2vh; background: white; border-radius: 50%; margin: 5px;" ></div>
          <div id="wasserstoffInfo"> = Wasserstoff</div>
      </div>
    </div>
    </div>

    </div>

    <div id = "overlay" style = "position: absolute; top: 0px; left: 0px; width: 100%; height: 100%; background: rgb(68, 102, 255);">
      <div id = "loading" class = "uiElement" style="position: absolute; left: 5%; top: 50%; font-size: 8vw;"></div>
    </div>

  </body>
  <script>
  </script>
</html>